import{d as T,s as P,i as M,r as $,j as V,k as j,c as i,l as w,a as e,g as D,t as y,m as q,u as G,o as r,_ as F,n as S,p as H,q as J,x as I,e as x,f as K,F as B,y as W,z as Q,A as X,B as O,T as Z,v as C,h as L}from"./index-xpvT0FfH.js";import{u as Y}from"./authStore-AaV84dP0.js";import{S as A}from"./sweetalert2.esm.all-ePrzfkxH.js";const ee={key:0,class:"user-menu"},te={class:"user-area"},ne=["aria-expanded"],se={class:"user-text"},oe={class:"dropdown",role:"menu"},ae=T({__name:"UserMenu",setup(h){const d=G(),_=Y(),{user:f,token:p}=P(_),v=M(()=>!!p.value),c=M(()=>{var u;return((u=f.value)==null?void 0:u.name)??"Guest"}),g=$(!1),s=()=>g.value=!g.value,k=()=>g.value=!1,l=u=>{u.target.closest(".user-menu")||k()};V(()=>document.addEventListener("click",l)),j(()=>document.removeEventListener("click",l));const a=()=>{_.logout(),k(),d.push({name:"Login"})};return(u,t)=>v.value?(r(),i("div",ee,[e("div",te,[e("button",{class:"user-trigger",onClick:s,"aria-expanded":g.value.toString(),"aria-haspopup":"menu","aria-label":"使用者選單"},[e("span",se,"Hi~ "+y(c.value)+"!",1),t[0]||(t[0]=e("span",{class:"chevron","aria-hidden":"true"},"▾",-1))],8,ne),D(e("ul",oe,[e("li",{role:"menuitem"},[e("button",{class:"dropdown-item",onClick:a},"登出")])],512),[[q,g.value]])])])):w("",!0)}}),le=F(ae,[["__scopeId","data-v-c611c89f"]]),re={class:"navbar"},ie=["aria-expanded"],ce={key:0,class:"nav-links"},ue=T({__name:"HamburgerButton",setup(h){const d=$(!1),_=$(window.innerWidth>=768),f=()=>{d.value=!d.value},p=()=>{_.value=window.innerWidth>=768};return V(()=>{p(),window.addEventListener("resize",p)}),j(()=>{window.removeEventListener("resize",p)}),(v,c)=>{const g=J("RouterLink");return r(),i("nav",re,[e("button",{class:H(["menu-icon",{active:d.value}]),onClick:f,"aria-label":"切換選單","aria-expanded":d.value.toString()},[...c[0]||(c[0]=[e("span",{class:"bar top"},null,-1),e("span",{class:"bar middle"},null,-1),e("span",{class:"bar bottom"},null,-1)])],10,ie),d.value||_.value?(r(),i("ul",ce,[e("li",null,[S(g,{to:"/student-area"},{default:I(()=>[...c[1]||(c[1]=[x("首頁",-1)])]),_:1})]),e("li",null,[S(g,{to:"/login"},{default:I(()=>[...c[2]||(c[2]=[x("帳號登入",-1)])]),_:1})]),e("li",null,[S(g,{to:{name:"StudentProgress"}},{default:I(()=>[...c[3]||(c[3]=[x("學習狀況",-1)])]),_:1})]),e("li",null,[S(g,{to:{name:"CourseIntro"}},{default:I(()=>[...c[4]||(c[4]=[x("課程介紹",-1)])]),_:1})])])):w("",!0),S(le)])}}}),de=F(ue,[["__scopeId","data-v-19642756"]]),R="https://home.sunnytseng.com/api/tutor/calendar/",pe="https://home.sunnytseng.com/api/tutor/import-workhours/",z=K("calendar",()=>{const h=$([]),d=$(!1),_=Y(),f=(l={})=>{const a={Accept:"application/json",...l};return _.token&&(a.Authorization=`Bearer ${_.token}`),a},p=l=>`${l.getFullYear()}-${(l.getMonth()+1).toString().padStart(2,"0")}-${l.getDate().toString().padStart(2,"0")}`,v=l=>h.value.filter(a=>p(new Date(a.datetime))===l),c=async()=>{d.value=!0;try{const l=await fetch(R,{method:"GET",headers:f()});if(!l.ok)throw new Error("Failed to load event data");h.value=await l.json()}catch(l){console.error("An error occurred while loading calendar events:",l)}finally{d.value=!1}};return{events:h,loading:d,getEventByDate:v,loadEvents:c,createEvent:async l=>{try{const{user_id:a,...u}=l,t=await fetch(R,{method:"POST",headers:f({"Content-Type":"application/json"}),body:JSON.stringify(u)});if(!t.ok){const n=await t.text();throw new Error(n||"Create failed")}const o=await t.json();return h.value.unshift(o),{success:!0,data:o}}catch(a){return{success:!1,message:(a==null?void 0:a.message)||"Create failed"}}},deleteEvent:async l=>{try{const a=await fetch(`${R}${l}/`,{method:"DELETE",headers:f()});if(a.status!==204&&!a.ok){const u=await a.text();throw new Error(u||"Delete failed")}return h.value=h.value.filter(u=>u.id!==l),{success:!0}}catch(a){return{success:!1,message:(a==null?void 0:a.message)||"Delete failed"}}},importWorkhours:async()=>{try{const l=await fetch(pe,{method:"POST",headers:f()}),a=await l.json().catch(()=>({}));if(!l.ok)throw new Error((a==null?void 0:a.error)||(a==null?void 0:a.message)||"Import failed");return await c(),{success:!0,message:(a==null?void 0:a.message)||"Imported"}}catch(l){return{success:!1,message:(l==null?void 0:l.message)||"Import failed"}}}}}),me={class:"calendar-container"},ve={key:0,class:"loading-overlay"},_e={key:1},ge={class:"calendar-header"},fe={class:"calendar-grid"},he=["onClick"],ye={key:0},we={key:0},be={key:1},ke=T({__name:"ScheduleCalendar",emits:["select-date"],setup(h,{emit:d}){const _=z(),f=$(!0);V(async()=>{try{await _.loadEvents()}catch(n){console.error("Failed to load events:",n),alert("Unable to load events, please try again later!")}finally{f.value=!1}});const p=new Date,v=$(new Date),c=M(()=>v.value.getFullYear()),g=M(()=>v.value.getMonth()),s=["日","一","二","三","四","五","六"],k=n=>`${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")}`,l=M(()=>{const n=c.value,m=g.value,b=new Date(n,m,1),N=new Date(n,m+1,0),U=[];for(let E=0;E<b.getDay();E++)U.push(null);for(let E=1;E<=N.getDate();E++)U.push(new Date(n,m,E));return U}),a=n=>n?n.getFullYear()===p.getFullYear()&&n.getMonth()===p.getMonth()&&n.getDate()===p.getDate():!1,u=n=>{if(!n)return!1;const m=k(n);return _.getEventByDate(m).length>0},t=()=>{const n=new Date(v.value);n.setDate(1),n.setMonth(n.getMonth()-1),v.value=n},o=()=>{const n=new Date(v.value);n.setDate(1),n.setMonth(n.getMonth()+1),v.value=n};return(n,m)=>(r(),i("div",me,[f.value?(r(),i("div",ve,[...m[0]||(m[0]=[e("span",{class:"loading-text"},"Loading...",-1)])])):(r(),i("div",_e,[e("div",ge,[e("button",{onClick:t},"‹"),e("h2",null,y(c.value)+" 年 "+y(g.value+1)+" 月",1),e("button",{onClick:o},"›")]),e("div",fe,[(r(),i(B,null,W(s,b=>e("div",{class:"day-name",key:b},y(b),1)),64)),(r(!0),i(B,null,W(l.value,(b,N)=>(r(),i("div",{class:H(["day-cell",{today:a(b)}]),key:N,onClick:U=>b&&n.selectDate(b)},[b?(r(),i("div",ye,[e("div",null,y(b.getDate()),1),u(b)?(r(),i("div",we,"☑️")):w("",!0)])):(r(),i("div",be," "))],10,he))),128))])]))]))}}),$e=F(ke,[["__scopeId","data-v-50596ebf"]]),De={key:0,class:"modal-backdrop"},Se={class:"modal-card",role:"dialog","aria-modal":"true"},Ce={class:"modal-body"},Ee={class:"row"},xe={class:"row"},Me={class:"row"},Be={class:"row"},Te={class:"row"},Fe={class:"row"},Ue={class:"row"},Ie={class:"modal-footer"},Le=["disabled"],Ae=T({__name:"CalendarEventForm",props:{open:{type:Boolean},defaultDate:{}},emits:["update:open","created"],setup(h,{emit:d}){const _=h,f=d,p=Y(),v=z(),c=$(!1),g=u=>u?`${u.length===16?`${u}:00`:u}+08:00`:"",s=Q({title:"",student_name:"",place:"",description:"",event_type:"",start_local:"",end_local:""});X(()=>_.open,u=>{if(u&&(s.student_name=p.getUserName||"",s.place="Office",s.title="Custom Event",s.event_type="custom",_.defaultDate)){const t=new Date(_.defaultDate);t.setHours(9,0,0,0);const o=n=>n.toString().padStart(2,"0");s.start_local=`${t.getFullYear()}-${o(t.getMonth()+1)}-${o(t.getDate())}T${o(t.getHours())}:${o(t.getMinutes())}`,s.end_local=""}});const k=async()=>{if(!p.token){A.fire({title:"請先登入",text:"需要 JWT 才能新增事件",icon:"warning",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}if(!s.title||!s.student_name||!s.place||!s.start_local){A.fire({title:"欄位不可空白",text:"請至少填標題、學生、地點與開始時間",icon:"info",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}const u={title:s.title.trim(),student_name:s.student_name.trim(),place:s.place.trim(),description:s.description.trim()||void 0,event_type:s.event_type.trim()||void 0,datetime:g(s.start_local),end_datetime:s.end_local?g(s.end_local):void 0};try{c.value=!0;const t=await v.createEvent(u);if(!t.success)throw new Error(t.message);await A.fire({title:"新增成功",text:"事件已建立",icon:"success",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}}),f("created"),f("update:open",!1)}catch(t){A.fire({title:"新增失敗",text:(t==null?void 0:t.message)??"Unknown error",icon:"error",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}})}finally{c.value=!1}},l=()=>f("update:open",!1);function a(u){_.open&&u.key==="Escape"&&l()}return V(()=>window.addEventListener("keydown",a)),j(()=>window.removeEventListener("keydown",a)),(u,t)=>(r(),O(Z,{to:"body"},[h.open?(r(),i("div",De,[e("div",Se,[e("header",{class:"modal-header"},[t[7]||(t[7]=e("h3",null,"新增行事曆事件",-1)),e("button",{class:"icon-btn",onClick:l,"aria-label":"Close"},"✕")]),e("div",Ce,[e("div",Ee,[t[8]||(t[8]=e("label",null,"標題",-1)),D(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>s.title=o),placeholder:"標題",required:""},null,512),[[C,s.title]])]),e("div",xe,[t[9]||(t[9]=e("label",null,"學生姓名",-1)),D(e("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>s.student_name=o),placeholder:"學生姓名",required:""},null,512),[[C,s.student_name]])]),e("div",Me,[t[10]||(t[10]=e("label",null,"開始時間",-1)),D(e("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>s.start_local=o),type:"datetime-local",required:""},null,512),[[C,s.start_local]])]),e("div",Be,[t[11]||(t[11]=e("label",null,"結束時間（可選）",-1)),D(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>s.end_local=o),type:"datetime-local"},null,512),[[C,s.end_local]])]),e("div",Te,[t[12]||(t[12]=e("label",null,"地點",-1)),D(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>s.place=o),placeholder:"地點",required:""},null,512),[[C,s.place]])]),e("div",Fe,[t[13]||(t[13]=e("label",null,"類型（可選）",-1)),D(e("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>s.event_type=o),placeholder:"custom / lesson / ..."},null,512),[[C,s.event_type]])]),e("div",Ue,[t[14]||(t[14]=e("label",null,"備註（可選）",-1)),D(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=o=>s.description=o),rows:"3",placeholder:"備註"},null,512),[[C,s.description]])])]),e("footer",Ie,[e("button",{class:"btn btn-secondary",onClick:l},"取消"),e("button",{class:"btn btn-primary",disabled:c.value,onClick:k},y(c.value?"送出中…":"新增事件"),9,Le)])])])):w("",!0)]))}}),Ve=F(Ae,[["__scopeId","data-v-9d06eb8c"]]),Ye={class:"schedule-container"},Ne={class:"schedule-header"},Re={key:0,class:"actions"},We={class:"schedule-content"},je={key:0,class:"loading"},ze={key:1,class:"no-events"},He={key:2,class:"event-list"},Oe={class:"event-main"},Pe={class:"event-time"},qe={class:"event-title"},Ge={class:"event-extra"},Je={key:0,class:"event-place"},Ke={key:1,class:"event-student"},Qe={key:2,class:"event-type"},Xe={key:0,class:"event-description"},Ze={key:1,class:"event-actions"},et=["onClick"],tt=T({__name:"DailySchedule",props:{date:{}},emits:["close"],setup(h,{emit:d}){const _=h,f=d,p=z(),v=Y(),c=$(!1),g=o=>`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`,s=M(()=>p.getEventByDate(g(_.date)).sort((o,n)=>new Date(o.datetime).getTime()-new Date(n.datetime).getTime())),k=o=>o?new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",l=()=>{if(!v.isAuthenticated){alert("請先登入");return}c.value=!0},a=async o=>{const n=await p.deleteEvent(o);n.success||alert(`刪除失敗：${n.message}（注意：只有超級用戶可刪除）`)},u=async()=>{const o=await p.importWorkhours();alert(o.success?o.message:`匯入失敗：${o.message}（注意：只有超級用戶可觸發）`)},t=async()=>{await p.loadEvents()};return(o,n)=>(r(),i(B,null,[e("div",Ye,[e("div",Ne,[e("h2",null,y(g(h.date))+" 行程",1),L(v).isAuthenticated?(r(),i("div",Re,[e("button",{class:"btn btn-primary",onClick:l},"＋ 新增"),L(v).isSuperuser?(r(),i("button",{key:0,class:"btn btn-secondary",onClick:u},"⇪ 匯入工時")):w("",!0)])):w("",!0),e("button",{class:"close-button",onClick:n[0]||(n[0]=m=>f("close"))},"✕")]),e("div",We,[L(p).loading?(r(),i("div",je,"載入中...")):s.value.length===0?(r(),i("div",ze,"該日無行程")):(r(),i("ul",He,[(r(!0),i(B,null,W(s.value,m=>(r(),i("li",{key:m.id,class:"event-item"},[e("div",Oe,[e("span",Pe,[x(y(k(m.datetime))+" ",1),m.end_datetime?(r(),i(B,{key:0},[x(" - "+y(k(m.end_datetime)),1)],64)):w("",!0)]),e("span",qe,"📘 "+y(m.title),1)]),e("div",Ge,[m.place?(r(),i("span",Je,"📍 "+y(m.place),1)):w("",!0),m.student_name?(r(),i("span",Ke,"👤 "+y(m.student_name),1)):w("",!0),m.event_type?(r(),i("span",Qe,"#"+y(m.event_type),1)):w("",!0)]),m.description?(r(),i("p",Xe,y(m.description),1)):w("",!0),L(v).isSuperuser?(r(),i("div",Ze,[e("button",{class:"btn btn-danger btn-sm",onClick:b=>a(m.id)},"刪除",8,et)])):w("",!0)]))),128))]))])]),S(Ve,{open:c.value,"onUpdate:open":n[1]||(n[1]=m=>c.value=m),defaultDate:h.date,onCreated:t},null,8,["open","defaultDate"])],64))}}),nt=F(tt,[["__scopeId","data-v-8c443531"]]),st={class:"main-content schedule-section"},ot=T({__name:"StudentArea",setup(h){const d=$(null),_=p=>{d.value&&d.value.getFullYear()===p.getFullYear()&&d.value.getMonth()===p.getMonth()&&d.value.getDate()===p.getDate()?d.value=null:d.value=p},f=()=>{d.value=null};return(p,v)=>(r(),i(B,null,[S(de),e("section",st,[v[0]||(v[0]=e("div",{id:"BannerWrapper"},[e("h1",{class:"title"},"預約時段")],-1)),S($e,{onSelectDate:_}),d.value?(r(),O(nt,{key:0,date:d.value,onClose:f},null,8,["date"])):w("",!0)])],64))}}),it=F(ot,[["__scopeId","data-v-759bb7fd"]]);export{it as default};
