import{d as U,s as G,i as T,r as D,j as N,k as H,c as u,l as b,a as e,g as C,t as w,m as J,u as K,o as r,_ as I,n as E,p as P,q as Q,x as A,e as B,f as X,F,y as z,z as Z,A as ee,B as q,T as te,v as x,h as V}from"./index-peb6hTeG.js";import{u as R}from"./authStore-CT5x_V2u.js";import{S as Y}from"./sweetalert2.esm.all-BQIkj5Wb.js";const ne={key:0,class:"user-menu"},se={class:"user-area"},oe=["aria-expanded"],ae={class:"user-text"},le={class:"dropdown",role:"menu"},re=U({__name:"UserMenu",setup(y){const d=K(),m=R(),{user:_,token:p}=G(m),f=T(()=>!!p.value),l=T(()=>{var c;return((c=_.value)==null?void 0:c.name)??"Guest"}),v=D(!1),n=()=>v.value=!v.value,$=()=>v.value=!1,a=c=>{c.target.closest(".user-menu")||$()};N(()=>document.addEventListener("click",a)),H(()=>document.removeEventListener("click",a));const o=()=>{m.logout(),$(),d.push({name:"Login"})};return(c,t)=>f.value?(r(),u("div",ne,[e("div",se,[e("button",{class:"user-trigger",onClick:n,"aria-expanded":v.value.toString(),"aria-haspopup":"menu","aria-label":"使用者選單"},[e("span",ae,"Hi~ "+w(l.value)+"!",1),t[0]||(t[0]=e("span",{class:"chevron","aria-hidden":"true"},"▾",-1))],8,oe),C(e("ul",le,[e("li",{role:"menuitem"},[e("button",{class:"dropdown-item",onClick:o},"登出")])],512),[[J,v.value]])])])):b("",!0)}}),ie=I(re,[["__scopeId","data-v-7520e317"]]),ce={class:"navbar"},ue=["aria-expanded"],de={key:0,class:"nav-links"},pe=U({__name:"HamburgerButton",setup(y){const d=D(!1),m=D(window.innerWidth>=768),_=()=>{d.value=!d.value},p=()=>{m.value=window.innerWidth>=768};return N(()=>{p(),window.addEventListener("resize",p)}),H(()=>{window.removeEventListener("resize",p)}),(f,l)=>{const v=Q("RouterLink");return r(),u("nav",ce,[e("button",{class:P(["menu-icon",{active:d.value}]),onClick:_,"aria-label":"切換選單","aria-expanded":d.value.toString()},l[0]||(l[0]=[e("span",{class:"bar top"},null,-1),e("span",{class:"bar middle"},null,-1),e("span",{class:"bar bottom"},null,-1)]),10,ue),d.value||m.value?(r(),u("ul",de,[e("li",null,[E(v,{to:"/student-area"},{default:A(()=>l[1]||(l[1]=[B("首頁",-1)])),_:1,__:[1]})]),e("li",null,[E(v,{to:"/login"},{default:A(()=>l[2]||(l[2]=[B("帳號登入",-1)])),_:1,__:[2]})]),e("li",null,[E(v,{to:{name:"StudentProgress"}},{default:A(()=>l[3]||(l[3]=[B("學習狀況",-1)])),_:1,__:[3]})]),e("li",null,[E(v,{to:{name:"CourseIntro"}},{default:A(()=>l[4]||(l[4]=[B("課程介紹",-1)])),_:1,__:[4]})])])):b("",!0),E(ie)])}}}),me=I(pe,[["__scopeId","data-v-d9f57bc4"]]),j="https://home.sunnytseng.com/api/tutor/calendar/",ve="https://home.sunnytseng.com/api/tutor/import-workhours/",O=X("calendar",()=>{const y=D([]),d=D(!1),m=R(),_=(a={})=>{const o={Accept:"application/json",...a};return m.token&&(o.Authorization=`Bearer ${m.token}`),o},p=a=>`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`,f=a=>y.value.filter(o=>p(new Date(o.datetime))===a),l=async()=>{d.value=!0;try{const a=await fetch(j,{method:"GET",headers:_()});if(!a.ok)throw new Error("Failed to load event data");y.value=await a.json()}catch(a){console.error("An error occurred while loading calendar events:",a)}finally{d.value=!1}};return{events:y,loading:d,getEventByDate:f,loadEvents:l,createEvent:async a=>{try{const{user_id:o,...c}=a,t=await fetch(j,{method:"POST",headers:_({"Content-Type":"application/json"}),body:JSON.stringify(c)});if(!t.ok){const h=await t.text();throw new Error(h||"Create failed")}const s=await t.json();return y.value.unshift(s),{success:!0,data:s}}catch(o){return{success:!1,message:(o==null?void 0:o.message)||"Create failed"}}},deleteEvent:async a=>{try{const o=await fetch(`${j}${a}/`,{method:"DELETE",headers:_()});if(o.status!==204&&!o.ok){const c=await o.text();throw new Error(c||"Delete failed")}return y.value=y.value.filter(c=>c.id!==a),{success:!0}}catch(o){return{success:!1,message:(o==null?void 0:o.message)||"Delete failed"}}},importWorkhours:async()=>{try{const a=await fetch(ve,{method:"POST",headers:_()}),o=await a.json().catch(()=>({}));if(!a.ok)throw new Error((o==null?void 0:o.error)||(o==null?void 0:o.message)||"Import failed");return await l(),{success:!0,message:(o==null?void 0:o.message)||"Imported"}}catch(a){return{success:!1,message:(a==null?void 0:a.message)||"Import failed"}}}}}),_e={class:"calendar-container"},ge={key:0,class:"loading-overlay"},fe={key:1},he={class:"calendar-header"},ye={class:"calendar-grid"},we=["onClick"],be={key:0},ke={key:0},$e={key:1},De=U({__name:"ScheduleCalendar",emits:["select-date"],setup(y,{emit:d}){const m=O(),_=D(!0),p=d;N(async()=>{try{await m.loadEvents()}catch(i){console.error("Failed to load events:",i),alert("Unable to load events, please try again later!")}finally{_.value=!1}});const f=new Date,l=D(new Date),v=T(()=>l.value.getFullYear()),n=T(()=>l.value.getMonth()),$=["日","一","二","三","四","五","六"],a=i=>`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,o=T(()=>{const i=v.value,S=n.value,k=new Date(i,S,1),W=new Date(i,S+1,0),L=[];for(let M=0;M<k.getDay();M++)L.push(null);for(let M=1;M<=W.getDate();M++)L.push(new Date(i,S,M));return L}),c=i=>i?i.getFullYear()===f.getFullYear()&&i.getMonth()===f.getMonth()&&i.getDate()===f.getDate():!1,t=i=>{if(!i)return!1;const S=a(i);return m.getEventByDate(S).length>0},s=()=>{const i=new Date(l.value);i.setMonth(i.getMonth()-1),l.value=i},h=()=>{const i=new Date(l.value);i.setMonth(i.getMonth()+1),l.value=i},g=i=>{p("select-date",i)};return(i,S)=>(r(),u("div",_e,[_.value?(r(),u("div",ge,S[0]||(S[0]=[e("span",{class:"loading-text"},"Loading...",-1)]))):(r(),u("div",fe,[e("div",he,[e("button",{onClick:s},"‹"),e("h2",null,w(v.value)+" 年 "+w(n.value+1)+" 月",1),e("button",{onClick:h},"›")]),e("div",ye,[(r(),u(F,null,z($,k=>e("div",{class:"day-name",key:k},w(k),1)),64)),(r(!0),u(F,null,z(o.value,(k,W)=>(r(),u("div",{class:P(["day-cell",{today:c(k)}]),key:W,onClick:L=>k&&g(k)},[k?(r(),u("div",be,[e("div",null,w(k.getDate()),1),t(k)?(r(),u("div",ke,"☑️")):b("",!0)])):(r(),u("div",$e," "))],10,we))),128))])]))]))}}),Se=I(De,[["__scopeId","data-v-f795518a"]]),Ce={key:0,class:"modal-backdrop"},Ee={class:"modal-card",role:"dialog","aria-modal":"true"},xe={class:"modal-body"},Me={class:"row"},Be={class:"row"},Te={class:"row"},Fe={class:"row"},Ue={class:"row"},Ie={class:"row"},Le={class:"row"},Ae={class:"modal-footer"},Ve=["disabled"],Ye=U({__name:"CalendarEventForm",props:{open:{type:Boolean},defaultDate:{}},emits:["update:open","created"],setup(y,{emit:d}){const m=y,_=d,p=R(),f=O(),l=D(!1),v=c=>c?`${c.length===16?`${c}:00`:c}+08:00`:"",n=Z({title:"",student_name:"",place:"",description:"",event_type:"",start_local:"",end_local:""});ee(()=>m.open,c=>{if(c&&(n.student_name=p.getUserName||"",n.place="Office",n.title="Custom Event",n.event_type="custom",m.defaultDate)){const t=new Date(m.defaultDate);t.setHours(9,0,0,0);const s=h=>h.toString().padStart(2,"0");n.start_local=`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}T${s(t.getHours())}:${s(t.getMinutes())}`,n.end_local=""}});const $=async()=>{if(!p.token){Y.fire({title:"請先登入",text:"需要 JWT 才能新增事件",icon:"warning",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}if(!n.title||!n.student_name||!n.place||!n.start_local){Y.fire({title:"欄位不可空白",text:"請至少填標題、學生、地點與開始時間",icon:"info",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}const c={title:n.title.trim(),student_name:n.student_name.trim(),place:n.place.trim(),description:n.description.trim()||void 0,event_type:n.event_type.trim()||void 0,datetime:v(n.start_local),end_datetime:n.end_local?v(n.end_local):void 0};try{l.value=!0;const t=await f.createEvent(c);if(!t.success)throw new Error(t.message);await Y.fire({title:"新增成功",text:"事件已建立",icon:"success",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}}),_("created"),_("update:open",!1)}catch(t){Y.fire({title:"新增失敗",text:(t==null?void 0:t.message)??"Unknown error",icon:"error",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}})}finally{l.value=!1}},a=()=>_("update:open",!1);function o(c){m.open&&c.key==="Escape"&&a()}return N(()=>window.addEventListener("keydown",o)),H(()=>window.removeEventListener("keydown",o)),(c,t)=>(r(),q(te,{to:"body"},[c.open?(r(),u("div",Ce,[e("div",Ee,[e("header",{class:"modal-header"},[t[7]||(t[7]=e("h3",null,"新增行事曆事件",-1)),e("button",{class:"icon-btn",onClick:a,"aria-label":"Close"},"✕")]),e("div",xe,[e("div",Me,[t[8]||(t[8]=e("label",null,"標題",-1)),C(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>n.title=s),placeholder:"標題",required:""},null,512),[[x,n.title]])]),e("div",Be,[t[9]||(t[9]=e("label",null,"學生姓名",-1)),C(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>n.student_name=s),placeholder:"學生姓名",required:""},null,512),[[x,n.student_name]])]),e("div",Te,[t[10]||(t[10]=e("label",null,"開始時間",-1)),C(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>n.start_local=s),type:"datetime-local",required:""},null,512),[[x,n.start_local]])]),e("div",Fe,[t[11]||(t[11]=e("label",null,"結束時間（可選）",-1)),C(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>n.end_local=s),type:"datetime-local"},null,512),[[x,n.end_local]])]),e("div",Ue,[t[12]||(t[12]=e("label",null,"地點",-1)),C(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>n.place=s),placeholder:"地點",required:""},null,512),[[x,n.place]])]),e("div",Ie,[t[13]||(t[13]=e("label",null,"類型（可選）",-1)),C(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>n.event_type=s),placeholder:"custom / lesson / ..."},null,512),[[x,n.event_type]])]),e("div",Le,[t[14]||(t[14]=e("label",null,"備註（可選）",-1)),C(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>n.description=s),rows:"3",placeholder:"備註"},null,512),[[x,n.description]])])]),e("footer",Ae,[e("button",{class:"btn btn-secondary",onClick:a},"取消"),e("button",{class:"btn btn-primary",disabled:l.value,onClick:$},w(l.value?"送出中…":"新增事件"),9,Ve)])])])):b("",!0)]))}}),Ne=I(Ye,[["__scopeId","data-v-540eab3c"]]),Re={class:"schedule-container"},We={class:"schedule-header"},je={key:0,class:"actions"},ze={class:"schedule-content"},He={key:0,class:"loading"},Oe={key:1,class:"no-events"},Pe={key:2,class:"event-list"},qe={class:"event-main"},Ge={class:"event-time"},Je={class:"event-title"},Ke={class:"event-extra"},Qe={key:0,class:"event-place"},Xe={key:1,class:"event-student"},Ze={key:2,class:"event-type"},et={key:0,class:"event-description"},tt={key:1,class:"event-actions"},nt=["onClick"],st=U({__name:"DailySchedule",props:{date:{}},emits:["close"],setup(y,{emit:d}){const m=y,_=d,p=O(),f=R(),l=D(!1),v=s=>`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}-${s.getDate().toString().padStart(2,"0")}`,n=T(()=>p.getEventByDate(v(m.date)).sort((s,h)=>new Date(s.datetime).getTime()-new Date(h.datetime).getTime())),$=s=>s?new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",a=()=>{if(!f.isAuthenticated){alert("請先登入");return}l.value=!0},o=async s=>{const h=await p.deleteEvent(s);h.success||alert(`刪除失敗：${h.message}（注意：只有超級用戶可刪除）`)},c=async()=>{const s=await p.importWorkhours();alert(s.success?s.message:`匯入失敗：${s.message}（注意：只有超級用戶可觸發）`)},t=async()=>{await p.loadEvents()};return(s,h)=>(r(),u(F,null,[e("div",Re,[e("div",We,[e("h2",null,w(v(s.date))+" 行程",1),V(f).isAuthenticated?(r(),u("div",je,[e("button",{class:"btn btn-primary",onClick:a},"＋ 新增"),V(f).isSuperuser?(r(),u("button",{key:0,class:"btn btn-secondary",onClick:c},"⇪ 匯入工時")):b("",!0)])):b("",!0),e("button",{class:"close-button",onClick:h[0]||(h[0]=g=>_("close"))},"✕")]),e("div",ze,[V(p).loading?(r(),u("div",He,"載入中...")):n.value.length===0?(r(),u("div",Oe,"該日無行程")):(r(),u("ul",Pe,[(r(!0),u(F,null,z(n.value,g=>(r(),u("li",{key:g.id,class:"event-item"},[e("div",qe,[e("span",Ge,[B(w($(g.datetime))+" ",1),g.end_datetime?(r(),u(F,{key:0},[B(" - "+w($(g.end_datetime)),1)],64)):b("",!0)]),e("span",Je,"📘 "+w(g.title),1)]),e("div",Ke,[g.place?(r(),u("span",Qe,"📍 "+w(g.place),1)):b("",!0),g.student_name?(r(),u("span",Xe,"👤 "+w(g.student_name),1)):b("",!0),g.event_type?(r(),u("span",Ze,"#"+w(g.event_type),1)):b("",!0)]),g.description?(r(),u("p",et,w(g.description),1)):b("",!0),V(f).isSuperuser?(r(),u("div",tt,[e("button",{class:"btn btn-danger btn-sm",onClick:i=>o(g.id)},"刪除",8,nt)])):b("",!0)]))),128))]))])]),E(Ne,{open:l.value,"onUpdate:open":h[1]||(h[1]=g=>l.value=g),defaultDate:s.date,onCreated:t},null,8,["open","defaultDate"])],64))}}),ot=I(st,[["__scopeId","data-v-631a2fb6"]]),at={class:"main-content schedule-section"},lt=U({__name:"StudentArea",setup(y){const d=D(null),m=p=>{d.value&&d.value.getFullYear()===p.getFullYear()&&d.value.getMonth()===p.getMonth()&&d.value.getDate()===p.getDate()?d.value=null:d.value=p},_=()=>{d.value=null};return(p,f)=>(r(),u(F,null,[E(me),e("section",at,[f[0]||(f[0]=e("div",{id:"BannerWrapper"},[e("h1",{class:"title"},"預約時段")],-1)),E(Se,{onSelectDate:m}),d.value?(r(),q(ot,{key:0,date:d.value,onClose:_},null,8,["date"])):b("",!0)])],64))}}),ut=I(lt,[["__scopeId","data-v-e5d9453d"]]);export{ut as default};
