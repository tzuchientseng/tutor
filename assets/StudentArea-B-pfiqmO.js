import{d as F,r as D,i as z,j as q,c,a as e,k as b,n as H,l as M,m as J,p as L,o as i,e as B,_ as I,f as G,q as Y,t as w,F as T,s as j,x as K,y as Q,z as R,T as X,g as C,v as E,h as V}from"./index-BGm1_9Hz.js";import{u as O}from"./authStore-C0NbZ8zE.js";import{S as A}from"./sweetalert2.esm.all-BQIkj5Wb.js";const Z={class:"navbar"},ee=["aria-expanded"],te={key:0,class:"nav-links"},ne=F({__name:"HamburgerButton",setup(y){const d=D(!1),v=D(window.innerWidth>=768),_=()=>{d.value=!d.value},u=()=>{v.value=window.innerWidth>=768};return z(()=>{u(),window.addEventListener("resize",u)}),q(()=>{window.removeEventListener("resize",u)}),(f,l)=>{const h=J("RouterLink");return i(),c("nav",Z,[e("button",{class:H(["menu-icon",{active:d.value}]),onClick:_,"aria-label":"切換選單","aria-expanded":d.value.toString()},l[0]||(l[0]=[e("span",{class:"bar top"},null,-1),e("span",{class:"bar middle"},null,-1),e("span",{class:"bar bottom"},null,-1)]),10,ee),d.value||v.value?(i(),c("ul",te,[e("li",null,[M(h,{to:"/"},{default:L(()=>l[1]||(l[1]=[B("首頁",-1)])),_:1,__:[1]})]),e("li",null,[M(h,{to:"/login"},{default:L(()=>l[2]||(l[2]=[B("帳號登入",-1)])),_:1,__:[2]})]),e("li",null,[M(h,{to:{name:"StudentProgress"}},{default:L(()=>l[3]||(l[3]=[B("學習狀況",-1)])),_:1,__:[3]})]),e("li",null,[M(h,{to:{name:"CourseIntro"}},{default:L(()=>l[4]||(l[4]=[B("課程介紹",-1)])),_:1,__:[4]})])])):b("",!0)])}}}),se=I(ne,[["__scopeId","data-v-33f0fc4d"]]),W="https://home.sunnytseng.com/api/tutor/calendar/",oe="https://home.sunnytseng.com/api/tutor/import-workhours/",P=G("calendar",()=>{const y=D([]),d=D(!1),v=O(),_=(a={})=>{const o={Accept:"application/json",...a};return v.token&&(o.Authorization=`Bearer ${v.token}`),o},u=a=>`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`,f=a=>y.value.filter(o=>u(new Date(o.datetime))===a),l=async()=>{d.value=!0;try{const a=await fetch(W,{method:"GET",headers:_()});if(!a.ok)throw new Error("Failed to load event data");y.value=await a.json()}catch(a){console.error("An error occurred while loading calendar events:",a)}finally{d.value=!1}};return{events:y,loading:d,getEventByDate:f,loadEvents:l,createEvent:async a=>{try{const{user_id:o,...p}=a,t=await fetch(W,{method:"POST",headers:_({"Content-Type":"application/json"}),body:JSON.stringify(p)});if(!t.ok){const g=await t.text();throw new Error(g||"Create failed")}const n=await t.json();return y.value.unshift(n),{success:!0,data:n}}catch(o){return{success:!1,message:(o==null?void 0:o.message)||"Create failed"}}},deleteEvent:async a=>{try{const o=await fetch(`${W}${a}/`,{method:"DELETE",headers:_()});if(o.status!==204&&!o.ok){const p=await o.text();throw new Error(p||"Delete failed")}return y.value=y.value.filter(p=>p.id!==a),{success:!0}}catch(o){return{success:!1,message:(o==null?void 0:o.message)||"Delete failed"}}},importWorkhours:async()=>{try{const a=await fetch(oe,{method:"POST",headers:_()}),o=await a.json().catch(()=>({}));if(!a.ok)throw new Error((o==null?void 0:o.error)||(o==null?void 0:o.message)||"Import failed");return await l(),{success:!0,message:(o==null?void 0:o.message)||"Imported"}}catch(a){return{success:!1,message:(a==null?void 0:a.message)||"Import failed"}}}}}),ae={class:"calendar-container"},le={key:0,class:"loading-overlay"},re={key:1},ie={class:"calendar-header"},ce={class:"calendar-grid"},de=["onClick"],ue={key:0},pe={key:0},me={key:1},ve=F({__name:"ScheduleCalendar",emits:["select-date"],setup(y,{emit:d}){const v=P(),_=D(!0),u=d;z(async()=>{try{await v.loadEvents()}catch(r){console.error("Failed to load events:",r),alert("Unable to load events, please try again later!")}finally{_.value=!1}});const f=new Date,l=D(new Date),h=Y(()=>l.value.getFullYear()),s=Y(()=>l.value.getMonth()),S=["日","一","二","三","四","五","六"],a=r=>`${r.getFullYear()}-${(r.getMonth()+1).toString().padStart(2,"0")}-${r.getDate().toString().padStart(2,"0")}`,o=Y(()=>{const r=h.value,$=s.value,k=new Date(r,$,1),N=new Date(r,$+1,0),U=[];for(let x=0;x<k.getDay();x++)U.push(null);for(let x=1;x<=N.getDate();x++)U.push(new Date(r,$,x));return U}),p=r=>r?r.getFullYear()===f.getFullYear()&&r.getMonth()===f.getMonth()&&r.getDate()===f.getDate():!1,t=r=>{if(!r)return!1;const $=a(r);return v.getEventByDate($).length>0},n=()=>{const r=new Date(l.value);r.setMonth(r.getMonth()-1),l.value=r},g=()=>{const r=new Date(l.value);r.setMonth(r.getMonth()+1),l.value=r},m=r=>{u("select-date",r)};return(r,$)=>(i(),c("div",ae,[_.value?(i(),c("div",le,$[0]||($[0]=[e("span",{class:"loading-text"},"Loading...",-1)]))):(i(),c("div",re,[e("div",ie,[e("button",{onClick:n},"‹"),e("h2",null,w(h.value)+" 年 "+w(s.value+1)+" 月",1),e("button",{onClick:g},"›")]),e("div",ce,[(i(),c(T,null,j(S,k=>e("div",{class:"day-name",key:k},w(k),1)),64)),(i(!0),c(T,null,j(o.value,(k,N)=>(i(),c("div",{class:H(["day-cell",{today:p(k)}]),key:N,onClick:U=>k&&m(k)},[k?(i(),c("div",ue,[e("div",null,w(k.getDate()),1),t(k)?(i(),c("div",pe,"☑️")):b("",!0)])):(i(),c("div",me," "))],10,de))),128))])]))]))}}),_e=I(ve,[["__scopeId","data-v-f795518a"]]),fe={key:0,class:"modal-backdrop"},ge={class:"modal-card",role:"dialog","aria-modal":"true"},he={class:"modal-body"},ye={class:"row"},we={class:"row"},be={class:"row"},ke={class:"row"},De={class:"row"},$e={class:"row"},Se={class:"row"},Ce={class:"modal-footer"},Ee=["disabled"],Me=F({__name:"CalendarEventForm",props:{open:{type:Boolean},defaultDate:{}},emits:["update:open","created"],setup(y,{emit:d}){const v=y,_=d,u=O(),f=P(),l=D(!1),h=p=>p?`${p.length===16?`${p}:00`:p}+08:00`:"",s=K({title:"",student_name:"",place:"",description:"",event_type:"",start_local:"",end_local:""});Q(()=>v.open,p=>{if(p&&(s.student_name=u.getUserName||"",s.place="Office",s.title="Custom Event",s.event_type="custom",v.defaultDate)){const t=new Date(v.defaultDate);t.setHours(9,0,0,0);const n=g=>g.toString().padStart(2,"0");s.start_local=`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())}T${n(t.getHours())}:${n(t.getMinutes())}`,s.end_local=""}});const S=async()=>{if(!u.token){A.fire({title:"請先登入",text:"需要 JWT 才能新增事件",icon:"warning",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}if(!s.title||!s.student_name||!s.place||!s.start_local){A.fire({title:"欄位不可空白",text:"請至少填標題、學生、地點與開始時間",icon:"info",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}const p={title:s.title.trim(),student_name:s.student_name.trim(),place:s.place.trim(),description:s.description.trim()||void 0,event_type:s.event_type.trim()||void 0,datetime:h(s.start_local),end_datetime:s.end_local?h(s.end_local):void 0};try{l.value=!0;const t=await f.createEvent(p);if(!t.success)throw new Error(t.message);await A.fire({title:"新增成功",text:"事件已建立",icon:"success",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}}),_("created"),_("update:open",!1)}catch(t){A.fire({title:"新增失敗",text:(t==null?void 0:t.message)??"Unknown error",icon:"error",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}})}finally{l.value=!1}},a=()=>_("update:open",!1);function o(p){v.open&&p.key==="Escape"&&a()}return z(()=>window.addEventListener("keydown",o)),q(()=>window.removeEventListener("keydown",o)),(p,t)=>(i(),R(X,{to:"body"},[p.open?(i(),c("div",fe,[e("div",ge,[e("header",{class:"modal-header"},[t[7]||(t[7]=e("h3",null,"新增行事曆事件",-1)),e("button",{class:"icon-btn",onClick:a,"aria-label":"Close"},"✕")]),e("div",he,[e("div",ye,[t[8]||(t[8]=e("label",null,"標題",-1)),C(e("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>s.title=n),placeholder:"標題",required:""},null,512),[[E,s.title]])]),e("div",we,[t[9]||(t[9]=e("label",null,"學生姓名",-1)),C(e("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>s.student_name=n),placeholder:"學生姓名",required:""},null,512),[[E,s.student_name]])]),e("div",be,[t[10]||(t[10]=e("label",null,"開始時間",-1)),C(e("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>s.start_local=n),type:"datetime-local",required:""},null,512),[[E,s.start_local]])]),e("div",ke,[t[11]||(t[11]=e("label",null,"結束時間（可選）",-1)),C(e("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>s.end_local=n),type:"datetime-local"},null,512),[[E,s.end_local]])]),e("div",De,[t[12]||(t[12]=e("label",null,"地點",-1)),C(e("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>s.place=n),placeholder:"地點",required:""},null,512),[[E,s.place]])]),e("div",$e,[t[13]||(t[13]=e("label",null,"類型（可選）",-1)),C(e("input",{"onUpdate:modelValue":t[5]||(t[5]=n=>s.event_type=n),placeholder:"custom / lesson / ..."},null,512),[[E,s.event_type]])]),e("div",Se,[t[14]||(t[14]=e("label",null,"備註（可選）",-1)),C(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=n=>s.description=n),rows:"3",placeholder:"備註"},null,512),[[E,s.description]])])]),e("footer",Ce,[e("button",{class:"btn btn-secondary",onClick:a},"取消"),e("button",{class:"btn btn-primary",disabled:l.value,onClick:S},w(l.value?"送出中…":"新增事件"),9,Ee)])])])):b("",!0)]))}}),xe=I(Me,[["__scopeId","data-v-540eab3c"]]),Be={class:"schedule-container"},Te={class:"schedule-header"},Fe={key:0,class:"actions"},Ie={class:"schedule-content"},Ue={key:0,class:"loading"},Le={key:1,class:"no-events"},Ve={key:2,class:"event-list"},Ae={class:"event-main"},Ye={class:"event-time"},Ne={class:"event-title"},We={class:"event-extra"},je={key:0,class:"event-place"},ze={key:1,class:"event-student"},Oe={key:2,class:"event-type"},Pe={key:0,class:"event-description"},qe={key:1,class:"event-actions"},He=["onClick"],Re=F({__name:"DailySchedule",props:{date:{}},emits:["close"],setup(y,{emit:d}){const v=y,_=d,u=P(),f=O(),l=D(!1),h=n=>`${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")}`,s=Y(()=>u.getEventByDate(h(v.date)).sort((n,g)=>new Date(n.datetime).getTime()-new Date(g.datetime).getTime())),S=n=>n?new Date(n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",a=()=>{if(!f.isAuthenticated){alert("請先登入");return}l.value=!0},o=async n=>{const g=await u.deleteEvent(n);g.success||alert(`刪除失敗：${g.message}（注意：只有超級用戶可刪除）`)},p=async()=>{const n=await u.importWorkhours();alert(n.success?n.message:`匯入失敗：${n.message}（注意：只有超級用戶可觸發）`)},t=async()=>{await u.loadEvents()};return(n,g)=>(i(),c(T,null,[e("div",Be,[e("div",Te,[e("h2",null,w(h(n.date))+" 行程",1),V(f).isAuthenticated?(i(),c("div",Fe,[e("button",{class:"btn btn-primary",onClick:a},"＋ 新增"),V(f).isSuperuser?(i(),c("button",{key:0,class:"btn btn-secondary",onClick:p},"⇪ 匯入工時")):b("",!0)])):b("",!0),e("button",{class:"close-button",onClick:g[0]||(g[0]=m=>_("close"))},"✕")]),e("div",Ie,[V(u).loading?(i(),c("div",Ue,"載入中...")):s.value.length===0?(i(),c("div",Le,"該日無行程")):(i(),c("ul",Ve,[(i(!0),c(T,null,j(s.value,m=>(i(),c("li",{key:m.id,class:"event-item"},[e("div",Ae,[e("span",Ye,[B(w(S(m.datetime))+" ",1),m.end_datetime?(i(),c(T,{key:0},[B(" - "+w(S(m.end_datetime)),1)],64)):b("",!0)]),e("span",Ne,"📘 "+w(m.title),1)]),e("div",We,[m.place?(i(),c("span",je,"📍 "+w(m.place),1)):b("",!0),m.student_name?(i(),c("span",ze,"👤 "+w(m.student_name),1)):b("",!0),m.event_type?(i(),c("span",Oe,"#"+w(m.event_type),1)):b("",!0)]),m.description?(i(),c("p",Pe,w(m.description),1)):b("",!0),V(f).isSuperuser?(i(),c("div",qe,[e("button",{class:"btn btn-danger btn-sm",onClick:r=>o(m.id)},"刪除",8,He)])):b("",!0)]))),128))]))])]),M(xe,{open:l.value,"onUpdate:open":g[1]||(g[1]=m=>l.value=m),defaultDate:n.date,onCreated:t},null,8,["open","defaultDate"])],64))}}),Je=I(Re,[["__scopeId","data-v-631a2fb6"]]),Ge={class:"main-content schedule-section"},Ke=F({__name:"StudentArea",setup(y){const d=D(null),v=u=>{d.value&&d.value.getFullYear()===u.getFullYear()&&d.value.getMonth()===u.getMonth()&&d.value.getDate()===u.getDate()?d.value=null:d.value=u},_=()=>{d.value=null};return(u,f)=>(i(),c(T,null,[M(se),e("section",Ge,[f[0]||(f[0]=e("div",{id:"BannerWrapper"},[e("h1",{class:"title"},"預約時段")],-1)),M(_e,{onSelectDate:v}),d.value?(i(),R(Je,{key:0,date:d.value,onClose:_},null,8,["date"])):b("",!0)])],64))}}),et=I(Ke,[["__scopeId","data-v-e5d9453d"]]);export{et as default};
