import{d as F,r as D,i as P,j as R,c as i,a as t,k as b,n as q,l as M,m as J,p as V,o as r,e as B,_ as I,f as G,q as Y,t as w,F as T,s as j,x as K,y as Q,z as H,T as X,w as Z,g as C,v as E,h as A}from"./index-D6-Tc4S9.js";import{u as z}from"./authStore-BX4LVYht.js";import{S as L}from"./sweetalert2.esm.all-BQIkj5Wb.js";const tt={class:"navbar"},et=["aria-expanded"],nt={key:0,class:"nav-links"},st=F({__name:"HamburgerButton",setup(h){const u=D(!1),_=D(window.innerWidth>=768),v=()=>{u.value=!u.value},p=()=>{_.value=window.innerWidth>=768};return P(()=>{p(),window.addEventListener("resize",p)}),R(()=>{window.removeEventListener("resize",p)}),(f,a)=>{const g=J("RouterLink");return r(),i("nav",tt,[t("button",{class:q(["menu-icon",{active:u.value}]),onClick:v,"aria-label":"切換選單","aria-expanded":u.value.toString()},a[0]||(a[0]=[t("span",{class:"bar top"},null,-1),t("span",{class:"bar middle"},null,-1),t("span",{class:"bar bottom"},null,-1)]),10,et),u.value||_.value?(r(),i("ul",nt,[t("li",null,[M(g,{to:"/"},{default:V(()=>a[1]||(a[1]=[B("首頁",-1)])),_:1,__:[1]})]),t("li",null,[M(g,{to:"/login"},{default:V(()=>a[2]||(a[2]=[B("帳號登入",-1)])),_:1,__:[2]})]),t("li",null,[M(g,{to:{name:"StudentProgress"}},{default:V(()=>a[3]||(a[3]=[B("學習狀況",-1)])),_:1,__:[3]})]),t("li",null,[M(g,{to:{name:"CourseIntro"}},{default:V(()=>a[4]||(a[4]=[B("課程介紹",-1)])),_:1,__:[4]})])])):b("",!0)])}}}),ot=I(st,[["__scopeId","data-v-33f0fc4d"]]),W="https://home.sunnytseng.com/api/tutor/calendar/",at="https://home.sunnytseng.com/api/tutor/import-workhours/",O=G("calendar",()=>{const h=D([]),u=D(!1),_=z(),v=(o={})=>{const n={Accept:"application/json",...o};return _.token&&(n.Authorization=`Bearer ${_.token}`),n},p=o=>`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`,f=o=>h.value.filter(n=>p(new Date(n.datetime))===o),a=async()=>{u.value=!0;try{const o=await fetch(W,{method:"GET",headers:v()});if(!o.ok)throw new Error("Failed to load event data");h.value=await o.json()}catch(o){console.error("An error occurred while loading calendar events:",o)}finally{u.value=!1}};return{events:h,loading:u,getEventByDate:f,loadEvents:a,createEvent:async o=>{try{const{user_id:n,...e}=o,c=await fetch(W,{method:"POST",headers:v({"Content-Type":"application/json"}),body:JSON.stringify(e)});if(!c.ok){const y=await c.text();throw new Error(y||"Create failed")}const d=await c.json();return h.value.unshift(d),{success:!0,data:d}}catch(n){return{success:!1,message:(n==null?void 0:n.message)||"Create failed"}}},deleteEvent:async o=>{try{const n=await fetch(`${W}${o}/`,{method:"DELETE",headers:v()});if(n.status!==204&&!n.ok){const e=await n.text();throw new Error(e||"Delete failed")}return h.value=h.value.filter(e=>e.id!==o),{success:!0}}catch(n){return{success:!1,message:(n==null?void 0:n.message)||"Delete failed"}}},importWorkhours:async()=>{try{const o=await fetch(at,{method:"POST",headers:v()}),n=await o.json().catch(()=>({}));if(!o.ok)throw new Error((n==null?void 0:n.error)||(n==null?void 0:n.message)||"Import failed");return await a(),{success:!0,message:(n==null?void 0:n.message)||"Imported"}}catch(o){return{success:!1,message:(o==null?void 0:o.message)||"Import failed"}}}}}),lt={class:"calendar-container"},rt={key:0,class:"loading-overlay"},it={key:1},ct={class:"calendar-header"},ut={class:"calendar-grid"},dt=["onClick"],pt={key:0},mt={key:0},vt={key:1},_t=F({__name:"ScheduleCalendar",emits:["select-date"],setup(h,{emit:u}){const _=O(),v=D(!0),p=u;P(async()=>{try{await _.loadEvents()}catch(l){console.error("Failed to load events:",l),alert("Unable to load events, please try again later!")}finally{v.value=!1}});const f=new Date,a=D(new Date),g=Y(()=>a.value.getFullYear()),s=Y(()=>a.value.getMonth()),S=["日","一","二","三","四","五","六"],o=l=>`${l.getFullYear()}-${(l.getMonth()+1).toString().padStart(2,"0")}-${l.getDate().toString().padStart(2,"0")}`,n=Y(()=>{const l=g.value,$=s.value,k=new Date(l,$,1),N=new Date(l,$+1,0),U=[];for(let x=0;x<k.getDay();x++)U.push(null);for(let x=1;x<=N.getDate();x++)U.push(new Date(l,$,x));return U}),e=l=>l?l.getFullYear()===f.getFullYear()&&l.getMonth()===f.getMonth()&&l.getDate()===f.getDate():!1,c=l=>{if(!l)return!1;const $=o(l);return _.getEventByDate($).length>0},d=()=>{const l=new Date(a.value);l.setMonth(l.getMonth()-1),a.value=l},y=()=>{const l=new Date(a.value);l.setMonth(l.getMonth()+1),a.value=l},m=l=>{p("select-date",l)};return(l,$)=>(r(),i("div",lt,[v.value?(r(),i("div",rt,$[0]||($[0]=[t("span",{class:"loading-text"},"Loading...",-1)]))):(r(),i("div",it,[t("div",ct,[t("button",{onClick:d},"‹"),t("h2",null,w(g.value)+" 年 "+w(s.value+1)+" 月",1),t("button",{onClick:y},"›")]),t("div",ut,[(r(),i(T,null,j(S,k=>t("div",{class:"day-name",key:k},w(k),1)),64)),(r(!0),i(T,null,j(n.value,(k,N)=>(r(),i("div",{class:q(["day-cell",{today:e(k)}]),key:N,onClick:U=>k&&m(k)},[k?(r(),i("div",pt,[t("div",null,w(k.getDate()),1),c(k)?(r(),i("div",mt,"☑️")):b("",!0)])):(r(),i("div",vt," "))],10,dt))),128))])]))]))}}),ft=I(_t,[["__scopeId","data-v-f795518a"]]),gt={class:"modal-card",role:"dialog","aria-modal":"true"},ht={class:"modal-body"},yt={class:"row"},wt={class:"row"},bt={class:"row"},kt={class:"row"},Dt={class:"row"},$t={class:"row"},St={class:"row"},Ct={class:"modal-footer"},Et=["disabled"],Mt=F({__name:"CalendarEventForm",props:{open:{type:Boolean},defaultDate:{}},emits:["update:open","created"],setup(h,{emit:u}){const _=h,v=u,p=z(),f=O(),a=D(!1),g=n=>n?`${n.length===16?`${n}:00`:n}+08:00`:"",s=K({title:"",student_name:"",place:"",description:"",event_type:"",start_local:"",end_local:""});Q(()=>_.open,n=>{if(n&&(s.student_name=p.getUserName||"",s.place="Office",s.title="Custom Event",s.event_type="custom",_.defaultDate)){const e=new Date(_.defaultDate);e.setHours(9,0,0,0);const c=d=>d.toString().padStart(2,"0");s.start_local=`${e.getFullYear()}-${c(e.getMonth()+1)}-${c(e.getDate())}T${c(e.getHours())}:${c(e.getMinutes())}`,s.end_local=""}});const S=async()=>{if(!p.token){L.fire({title:"請先登入",text:"需要 JWT 才能新增事件",icon:"warning",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}if(!s.title||!s.student_name||!s.place||!s.start_local){L.fire({title:"欄位不可空白",text:"請至少填標題、學生、地點與開始時間",icon:"info",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}});return}const n={title:s.title.trim(),student_name:s.student_name.trim(),place:s.place.trim(),description:s.description.trim()||void 0,event_type:s.event_type.trim()||void 0,datetime:g(s.start_local),end_datetime:s.end_local?g(s.end_local):void 0};try{a.value=!0;const e=await f.createEvent(n);if(!e.success)throw new Error(e.message);await L.fire({title:"新增成功",text:"事件已建立",icon:"success",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}}),v("created"),v("update:open",!1)}catch(e){L.fire({title:"新增失敗",text:(e==null?void 0:e.message)??"Unknown error",icon:"error",buttonsStyling:!1,customClass:{popup:"sw-popup",confirmButton:"btn btn-primary",cancelButton:"btn btn-secondary"}})}finally{a.value=!1}},o=()=>v("update:open",!1);return(n,e)=>(r(),H(X,{to:"body"},[n.open?(r(),i("div",{key:0,class:"modal-backdrop",onClick:Z(o,["self"])},[t("div",gt,[t("header",{class:"modal-header"},[e[7]||(e[7]=t("h3",null,"新增行事曆事件",-1)),t("button",{class:"icon-btn",onClick:o,"aria-label":"Close"},"✕")]),t("div",ht,[t("div",yt,[e[8]||(e[8]=t("label",null,"標題",-1)),C(t("input",{"onUpdate:modelValue":e[0]||(e[0]=c=>s.title=c),placeholder:"標題",required:""},null,512),[[E,s.title]])]),t("div",wt,[e[9]||(e[9]=t("label",null,"學生姓名",-1)),C(t("input",{"onUpdate:modelValue":e[1]||(e[1]=c=>s.student_name=c),placeholder:"學生姓名",required:""},null,512),[[E,s.student_name]])]),t("div",bt,[e[10]||(e[10]=t("label",null,"開始時間",-1)),C(t("input",{"onUpdate:modelValue":e[2]||(e[2]=c=>s.start_local=c),type:"datetime-local",required:""},null,512),[[E,s.start_local]])]),t("div",kt,[e[11]||(e[11]=t("label",null,"結束時間（可選）",-1)),C(t("input",{"onUpdate:modelValue":e[3]||(e[3]=c=>s.end_local=c),type:"datetime-local"},null,512),[[E,s.end_local]])]),t("div",Dt,[e[12]||(e[12]=t("label",null,"地點",-1)),C(t("input",{"onUpdate:modelValue":e[4]||(e[4]=c=>s.place=c),placeholder:"地點",required:""},null,512),[[E,s.place]])]),t("div",$t,[e[13]||(e[13]=t("label",null,"類型（可選）",-1)),C(t("input",{"onUpdate:modelValue":e[5]||(e[5]=c=>s.event_type=c),placeholder:"custom / lesson / ..."},null,512),[[E,s.event_type]])]),t("div",St,[e[14]||(e[14]=t("label",null,"備註（可選）",-1)),C(t("textarea",{"onUpdate:modelValue":e[6]||(e[6]=c=>s.description=c),rows:"3",placeholder:"備註"},null,512),[[E,s.description]])])]),t("footer",Ct,[t("button",{class:"btn btn-secondary",onClick:o},"取消"),t("button",{class:"btn btn-primary",disabled:a.value,onClick:S},w(a.value?"送出中…":"新增事件"),9,Et)])])])):b("",!0)]))}}),xt=I(Mt,[["__scopeId","data-v-7a9076b6"]]),Bt={class:"schedule-container"},Tt={class:"schedule-header"},Ft={key:0,class:"actions"},It={class:"schedule-content"},Ut={key:0,class:"loading"},Vt={key:1,class:"no-events"},At={key:2,class:"event-list"},Lt={class:"event-main"},Yt={class:"event-time"},Nt={class:"event-title"},Wt={class:"event-extra"},jt={key:0,class:"event-place"},zt={key:1,class:"event-student"},Ot={key:2,class:"event-type"},Pt={key:0,class:"event-description"},qt={key:1,class:"event-actions"},Ht=["onClick"],Rt=F({__name:"DailySchedule",props:{date:{}},emits:["close"],setup(h,{emit:u}){const _=h,v=u,p=O(),f=z(),a=D(!1),g=d=>`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,"0")}-${d.getDate().toString().padStart(2,"0")}`,s=Y(()=>p.getEventByDate(g(_.date)).sort((d,y)=>new Date(d.datetime).getTime()-new Date(y.datetime).getTime())),S=d=>d?new Date(d).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",o=()=>{if(!f.isAuthenticated){alert("請先登入");return}a.value=!0},n=async d=>{const y=await p.deleteEvent(d);y.success||alert(`刪除失敗：${y.message}（注意：只有超級用戶可刪除）`)},e=async()=>{const d=await p.importWorkhours();alert(d.success?d.message:`匯入失敗：${d.message}（注意：只有超級用戶可觸發）`)},c=async()=>{await p.loadEvents()};return(d,y)=>(r(),i(T,null,[t("div",Bt,[t("div",Tt,[t("h2",null,w(g(d.date))+" 行程",1),A(f).isAuthenticated?(r(),i("div",Ft,[t("button",{class:"btn btn-primary",onClick:o},"＋ 新增"),A(f).isSuperuser?(r(),i("button",{key:0,class:"btn btn-secondary",onClick:e},"⇪ 匯入工時")):b("",!0)])):b("",!0),t("button",{class:"close-button",onClick:y[0]||(y[0]=m=>v("close"))},"✕")]),t("div",It,[A(p).loading?(r(),i("div",Ut,"載入中...")):s.value.length===0?(r(),i("div",Vt,"該日無行程")):(r(),i("ul",At,[(r(!0),i(T,null,j(s.value,m=>(r(),i("li",{key:m.id,class:"event-item"},[t("div",Lt,[t("span",Yt,[B(w(S(m.datetime))+" ",1),m.end_datetime?(r(),i(T,{key:0},[B(" - "+w(S(m.end_datetime)),1)],64)):b("",!0)]),t("span",Nt,"📘 "+w(m.title),1)]),t("div",Wt,[m.place?(r(),i("span",jt,"📍 "+w(m.place),1)):b("",!0),m.student_name?(r(),i("span",zt,"👤 "+w(m.student_name),1)):b("",!0),m.event_type?(r(),i("span",Ot,"#"+w(m.event_type),1)):b("",!0)]),m.description?(r(),i("p",Pt,w(m.description),1)):b("",!0),A(f).isSuperuser?(r(),i("div",qt,[t("button",{class:"btn btn-danger btn-sm",onClick:l=>n(m.id)},"刪除",8,Ht)])):b("",!0)]))),128))]))])]),M(xt,{open:a.value,"onUpdate:open":y[1]||(y[1]=m=>a.value=m),defaultDate:d.date,onCreated:c},null,8,["open","defaultDate"])],64))}}),Jt=I(Rt,[["__scopeId","data-v-631a2fb6"]]),Gt={class:"main-content schedule-section"},Kt=F({__name:"StudentArea",setup(h){const u=D(null),_=p=>{u.value&&u.value.getFullYear()===p.getFullYear()&&u.value.getMonth()===p.getMonth()&&u.value.getDate()===p.getDate()?u.value=null:u.value=p},v=()=>{u.value=null};return(p,f)=>(r(),i(T,null,[M(ot),t("section",Gt,[f[0]||(f[0]=t("div",{id:"BannerWrapper"},[t("h1",{class:"title"},"預約時段")],-1)),M(ft,{onSelectDate:_}),u.value?(r(),H(Jt,{key:0,date:u.value,onClose:v},null,8,["date"])):b("",!0)])],64))}}),te=I(Kt,[["__scopeId","data-v-e5d9453d"]]);export{te as default};
